import {useCallback, useId, useState} from "react";
import {AuthService} from "../services/AuthService";
import {ErrorMessage, Field, Form, Formik} from "formik";
import * as Yup from "yup";
import {loginUser, setAuth} from "../actions";
import {useDispatch} from "react-redux";
import {useNavigate} from "react-router-dom";
import {localStorageKeyAuth} from "../utils/constants";
import {Helmet} from "react-helmet";

const AuthPage = () => {
    const [error, setError] = useState(undefined)
    const dispatch = useDispatch()
    const navigate = useNavigate()

    const identityFieldId = useId()
    const passwordFieldId = useId()

    const authApi = new AuthService()

    const handleSubmit = useCallback(async ({identity, password}) => {
        try {
            const response = await authApi.login(identity, password)
            localStorage.setItem(localStorageKeyAuth, response.data.accessToken)
            dispatch(setAuth(true))
            dispatch(loginUser(response.data.user))
            navigate('/')
            if (error) setError(undefined)
        } catch (e) {
            setError(e.response.data.message)
        }
    }, [error])

    return <div>
        <Helmet>
            <meta name="keywords" content="Авторизация, войти"/>
        </Helmet>
        <Formik
            initialValues={{
                identity: "",
                password: ""
            }}
            validationSchema={Yup.object({
                identity: Yup.string().required("Обязательное поле!"),
                password: Yup.string().required("Обязательное поле!").min(6, "Минимальное количество символов 6")
            })}
            onSubmit={async (values) => {
                await handleSubmit(values)
            }}>
            {({dirty, isValid, isSubmitting}) => <Form>
                <h1>Войти</h1>
                <div>
                    <div>
                        <label htmlFor={identityFieldId}>
                            Логин
                        </label>
                    </div>
                    <div>
                        <Field id={identityFieldId} placeholder={"yruzik"} type={"text"} name={"identity"}/>
                    </div>
                    <div>
                        <ErrorMessage name={"identity"}/>
                    </div>
                </div>
                <div>
                    <div>
                        <label htmlFor={passwordFieldId}>
                            Пароль
                        </label>
                    </div>
                    <div>
                        <Field id={passwordFieldId} placeholder={"123123"} type={"password"} name={"password"}/>
                    </div>
                    <div>
                        <ErrorMessage name={"password"}/>
                    </div>
                </div>
                {error && <div>{error}</div>}
                <button disabled={isSubmitting || !isValid || !dirty} type={"submit"}>Авторизоваться</button>
            </Form>}
        </Formik>
    </div>
}

export default AuthPage